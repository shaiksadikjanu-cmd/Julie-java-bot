<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julu AI - Java Backend</title>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mermaid for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <style>
        /* --- CSS VARIABLES (Taken from your App.css) --- */
        :root {
            --bg-color: #f0f2f5; --header-bg: #ffffff; --text-color: #111111;
            --panel-bg: #ffffff; --panel-border: #ddd; --input-bg: #ffffff;
            --user-bubble: #007bff; --user-text: #ffffff; --bot-bubble: #ffffff;
            --active-chat: #e6f2ff; --select-bg: #f8f9fa; --modal-bg: #ffffff;
            --success: #00b894; --danger: #d63031; --menu-bg: #ffffff;
            --menu-shadow: rgba(0,0,0,0.15);
        }

        [data-theme='dark'] {
            --bg-color: #121212; --header-bg: #1f1f1f; --text-color: #e0e0e0;
            --panel-bg: #1f1f1f; --panel-border: #333; --input-bg: #2d2d2d;
            --bot-bubble: #2d2d2d; --active-chat: #333; --select-bg: #2d2d2d;
            --modal-bg: #2d2d2d; --menu-bg: #2d2d2d; --menu-shadow: rgba(0,0,0,0.5);
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }

        /* HEADER */
        .app-header { padding: 15px 20px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--panel-border); z-index: 10; }
        .header-title { margin: 0; font-size: 1.5rem; }
        .model-badge { font-size: 10px; background: var(--panel-border); padding: 2px 6px; border-radius: 4px; margin-left: 10px; color: var(--text-color); }
        .icon-btn { cursor: pointer; background: none; border: none; font-size: 20px; color: var(--text-color); padding: 5px; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.1); }

        /* SIDE PANEL */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        .side-panel { position: fixed; top: 0; right: 0; width: 300px; height: 100%; background: var(--panel-bg); transform: translateX(100%); transition: transform 0.3s; z-index: 100; display: flex; flex-direction: column; border-left: 1px solid var(--panel-border); }
        .side-panel.open { transform: translateX(0); }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .settings-container { padding: 15px; border-bottom: 1px solid var(--panel-border); }
        .select-input, .range-input { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid var(--panel-border); background: var(--select-bg); color: var(--text-color); box-sizing: border-box; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; color: var(--text-color); }
        .history-item.active { background: var(--active-chat); }
        .theme-toggle { margin: 20px; padding: 10px; border-radius: 10px; border: 1px solid var(--panel-border); background: transparent; color: var(--text-color); cursor: pointer; }

        /* CHAT AREA */
        .chat-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.bot { justify-content: flex-start; }
        .message-bubble { padding: 12px 18px; border-radius: 15px; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.5; word-wrap: break-word; }
        .message-bubble.user { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 2px; }
        .message-bubble.bot { background: var(--bot-bubble); color: var(--text-color); border-bottom-left-radius: 2px; }
        .message-image { max-width: 100%; border-radius: 10px; margin-bottom: 10px; display: block; }

        /* MERMAID & Markdown Styles */
        .mermaid-wrapper { background: white; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid #ccc; }
        pre { background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; overflow-x: auto; }
        
        /* INPUT AREA */
        .input-area { padding: 20px; background: var(--header-bg); display: flex; gap: 10px; border-top: 1px solid var(--panel-border); align-items: center; position: relative; }
        .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid var(--panel-border); background: var(--input-bg); color: var(--text-color); font-size: 16px; outline: none; }
        .plus-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--select-bg); display: flex; justify-content: center; align-items: center; border: 1px solid var(--panel-border); font-size: 24px; font-weight: bold; cursor: pointer; }
        .plus-btn.active { background: var(--danger); color: white; transform: rotate(45deg); }
        .attach-menu { position: absolute; bottom: 70px; left: 20px; background: var(--menu-bg); border: 1px solid var(--panel-border); border-radius: 12px; display: none; flex-direction: column; min-width: 120px; box-shadow: 0 4px 15px var(--menu-shadow); }
        .menu-item { padding: 12px; border: none; background: none; color: var(--text-color); text-align: left; cursor: pointer; border-bottom: 1px solid var(--panel-border); }
        .menu-item:hover { background: var(--select-bg); }
        .menu-item.listening { color: var(--danger); font-weight: bold; }
        .preview-container { position: absolute; bottom: 80px; left: 70px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 2px solid var(--success); }
        
        /* LOADING DOTS */
        .typing-indicator { display: flex; gap: 5px; }
        .typing-dot { width: 8px; height: 8px; background: var(--text-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; opacity: 0.6; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .btn { padding: 8px 15px; border-radius: 5px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; }
        .btn:disabled { opacity: 0.5; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="app-header">
        <div style="display: flex; align-items: center">
            <h2 class="header-title">Julu AI</h2>
            <span class="model-badge" id="current-model-display">Flash 2.5</span>
        </div>
        <button class="icon-btn" onclick="togglePanel(true)">‚ò∞</button>
    </header>

    <!-- Side Panel -->
    <div class="overlay" id="overlay" onclick="togglePanel(false)"></div>
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <span>Settings</span>
            <button class="icon-btn" onclick="togglePanel(false)">‚úï</button>
        </div>
        <div class="settings-container">
            <label>üîë API Key:</label>
            <input type="password" id="api-key-input" class="select-input" placeholder="Paste Gemini Key...">
        </div>
        <div class="settings-container">
            <label>üó£Ô∏è Voice Lang:</label>
            <select id="voice-lang-select" class="select-input" onchange="updateVoiceSettings()">
                <option value="en-US">English (US)</option>
                <option value="en-IN">English (India)</option>
                <option value="hi-IN">Hindi</option>
            </select>
            <div style="margin-top: 10px; display:flex; gap:5px">
                <div style="flex:1"><small>Pitch</small><input type="range" id="pitch-range" min="0.5" max="2" step="0.1" value="1" class="range-input"></div>
                <div style="flex:1"><small>Rate</small><input type="range" id="rate-range" min="0.5" max="2" step="0.1" value="1" class="range-input"></div>
            </div>
        </div>
        <div class="settings-container">
            <label>üß† Model:</label>
            <select id="model-select" class="select-input" onchange="saveSettings()">
                <option value="gemini-2.5-flash-preview">Flash 2.5</option>
                <option value="gemini-3-flash-preview">Flash 3</option>
            </select>
            <label style="margin-top:10px; display:block">üß† System Rules:</label>
            <textarea id="system-rules" class="select-input" rows="3">You are Julu. If asked for diagrams, generate Mermaid JS code wrapped in ```mermaid ... ```.</textarea>
        </div>
        <div style="padding:15px"><button class="btn" style="width:100%" onclick="createNewChat()">+ New Chat</button></div>
        <div class="history-list" id="history-list"></div>
        <button class="theme-toggle" onclick="toggleTheme()">üåì Toggle Theme</button>
    </div>

    <!-- Chat Area -->
    <div class="chat-list" id="chat-list">
        <div style="text-align: center; margin-top: 50px; opacity: 0.5;">
            <h3>Hi Janu!</h3>
            <p>I am Julu (Java Version).<br>Set your API Key in the menu to start.</p>
        </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div id="preview-area" class="preview-container" style="display:none"></div>
        
        <div style="position:relative">
            <button class="plus-btn" id="plus-btn" onclick="toggleAttachMenu()">Ôºã</button>
            <div class="attach-menu" id="attach-menu">
                <input type="file" id="file-input" accept="image/*" hidden onchange="handleFileSelect(this)">
                <button class="menu-item" onclick="document.getElementById('file-input').click()">üñºÔ∏è Image</button>
                <button class="menu-item" id="mic-btn" onclick="toggleVoice()">üé§ Voice</button>
            </div>
        </div>

        <input type="text" class="chat-input" id="user-input" placeholder="Message..." onkeypress="handleEnter(event)">
        <button class="btn" onclick="sendMessage()" id="send-btn">Send</button>
    </div>

    <script>
        // --- STATE ---
        let state = {
            apiKey: localStorage.getItem('julu_api_key') || "",
            chats: JSON.parse(localStorage.getItem('julu_chats')) || [{ id: Date.now(), title: "New Chat", messages: [] }],
            activeChatId: null, // Will set in init
            model: localStorage.getItem('julu_model') || "gemini-3-flash-preview",
            theme: localStorage.getItem('julu_theme') || "dark",
            currentImage: null,
            isListening: false
        };

        // Initialize
        function init() {
            // Set Active Chat
            if (!state.chats.length) state.chats = [{ id: Date.now(), title: "New Chat", messages: [] }];
            state.activeChatId = state.chats[0].id;

            // Load UI Values
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-select').value = state.model;
            document.body.setAttribute('data-theme', state.theme);
            
            // Mermaid Init
            mermaid.initialize({ startOnLoad: true, theme: state.theme === 'dark' ? 'dark' : 'default' });

            // Listeners for auto-save
            document.getElementById('api-key-input').addEventListener('input', (e) => {
                state.apiKey = e.target.value;
                localStorage.setItem('julu_api_key', state.apiKey);
            });

            renderHistory();
            renderChat();
        }

        // --- RENDER FUNCTIONS ---
        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            state.chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `history-item ${chat.id === state.activeChatId ? 'active' : ''}`;
                div.innerHTML = `<span>${chat.title}</span> <span style="color:red" onclick="deleteChat(event, ${chat.id})">x</span>`;
                div.onclick = () => { state.activeChatId = chat.id; renderHistory(); renderChat(); togglePanel(false); };
                list.appendChild(div);
            });
        }

        function renderChat() {
            const chatBox = document.getElementById('chat-list');
            chatBox.innerHTML = '';
            const chat = state.chats.find(c => c.id === state.activeChatId);
            
            if(!chat || chat.messages.length === 0) {
                chatBox.innerHTML = `<div style="text-align: center; margin-top: 50px; opacity: 0.5;"><h3>Hi Janu!</h3><p>I am Julu (Java Version).</p></div>`;
                return;
            }

            chat.messages.forEach(msg => {
                const row = document.createElement('div');
                row.className = `message-row ${msg.role}`;
                
                let content = "";
                if (msg.image) content += `<img src="${msg.image}" class="message-image">`;
                
                // Parse Markdown
                let textHtml = marked.parse(msg.text);
                
                // Handle Mermaid blocks specially (simple replace for now, ideally needs parsing)
                if (msg.text.includes('```mermaid')) {
                     textHtml = textHtml.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                        '<div class="mermaid-wrapper"><div class="mermaid">$1</div></div>');
                }

                content += `<div class="message-bubble ${msg.role}">${textHtml} 
                            ${msg.role === 'bot' ? `<button style="background:none;border:none;cursor:pointer" onclick="speak('${msg.text.replace(/'/g, "\\'")}')">üîä</button>` : ''}
                            </div>`;
                
                row.innerHTML = content;
                chatBox.appendChild(row);
            });
            
            // Re-run mermaid on new DOM elements
            mermaid.run();
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- CORE LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text && !state.currentImage) return;

            if (!state.apiKey) { alert("Please enter API Key in settings!"); togglePanel(true); return; }

            const chat = state.chats.find(c => c.id === state.activeChatId);
            
            // 1. Add User Message
            const userMsg = { role: 'user', text: text, image: state.currentImage };
            chat.messages.push(userMsg);
            if (chat.messages.length === 1) chat.title = text.substring(0, 20) || "Image Chat";
            
            input.value = '';
            clearImage();
            renderChat();
            saveChats();

            // 2. Show Loading
            const loadingId = showLoading();

            try {
                // 3. Prepare Payload for Java -> Gemini
                // We construct the raw JSON here to save Java from doing it
                const historyParts = chat.messages.map(m => {
                    let parts = [{ text: m.text || " " }];
                    if (m.image) {
                        // Remove data:image/png;base64, prefix
                        const base64 = m.image.split(',')[1];
                        parts.push({ inline_data: { mime_type: "image/png", data: base64 } });
                    }
                    // Map 'bot' to 'model' for API
                    return { role: m.role === 'user' ? 'user' : 'model', parts: parts };
                });
                
                // Add System Instruction
                const sysRules = document.getElementById('system-rules').value;
                
                const payload = {
                    contents: historyParts,
                    system_instruction: { parts: [{ text: sysRules }] }
                };

                // 4. Send to Java
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'x-gemini-api-key': state.apiKey,
                        'x-gemini-model': state.model
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(await response.text());

                const data = await response.json();
                const botText = data.candidates[0].content.parts[0].text;

                // 5. Add Bot Message
                chat.messages.push({ role: 'bot', text: botText });
                removeLoading(loadingId);
                renderChat();
                renderHistory();
                saveChats();

            } catch (err) {
                console.error(err);
                chat.messages.push({ role: 'bot', text: "**Error:** " + err.message });
                removeLoading(loadingId);
                renderChat();
                saveChats();
            }
        }

        // --- UTILS ---
        function showLoading() {
            const chatBox = document.getElementById('chat-list');
            const div = document.createElement('div');
            div.id = 'loading-indicator';
            div.className = 'message-row bot';
            div.innerHTML = `<div class="message-bubble bot typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return 'loading-indicator';
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function createNewChat() {
            const newChat = { id: Date.now(), title: "New Chat", messages: [] };
            state.chats.unshift(newChat);
            state.activeChatId = newChat.id;
            saveChats();
            renderHistory();
            renderChat();
            togglePanel(false);
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.chats.length === 0) createNewChat();
            else {
                state.activeChatId = state.chats[0].id;
                renderHistory();
                renderChat();
            }
            saveChats();
        }

        function saveChats() { localStorage.setItem('julu_chats', JSON.stringify(state.chats)); }
        function saveSettings() {
             state.model = document.getElementById('model-select').value;
             localStorage.setItem('julu_model', state.model);
             document.getElementById('current-model-display').innerText = state.model;
        }

        function togglePanel(open) {
            const panel = document.getElementById('side-panel');
            const overlay = document.getElementById('overlay');
            if(open) { panel.classList.add('open'); overlay.style.display = 'block'; }
            else { panel.classList.remove('open'); overlay.style.display = 'none'; }
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', state.theme);
            localStorage.setItem('julu_theme', state.theme);
            renderChat(); // Re-render mermaid
        }

        // --- IMAGES & FILES ---
        function toggleAttachMenu() {
            const menu = document.getElementById('attach-menu');
            const btn = document.getElementById('plus-btn');
            const isOpen = menu.style.display === 'flex';
            menu.style.display = isOpen ? 'none' : 'flex';
            btn.classList.toggle('active', !isOpen);
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentImage = e.target.result;
                const area = document.getElementById('preview-area');
                area.style.display = 'block';
                area.innerHTML = `<img src="${state.currentImage}" class="preview-img"><button style="background:red;color:white;border:none;border-radius:50%;position:absolute;top:-5px;right:-5px;cursor:pointer" onclick="clearImage()">x</button>`;
                toggleAttachMenu();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            state.currentImage = null;
            document.getElementById('preview-area').style.display = 'none';
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // --- VOICE ---
        function toggleVoice() {
            if (state.isListening) {
                // Stop logic is automatic in simple implementation, or handled by browser
                return; 
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Voice not supported in this browser."); return; }
            
            const recognition = new SpeechRecognition();
            recognition.lang = document.getElementById('voice-lang-select').value;
            recognition.start();
            state.isListening = true;
            document.getElementById('mic-btn').classList.add('listening');
            document.getElementById('mic-btn').innerText = "üõë Listening...";

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('user-input').value += " " + transcript;
                stopVoice();
            };
            recognition.onerror = () => stopVoice();
            recognition.onend = () => stopVoice();
        }

        function stopVoice() {
            state.isListening = false;
            document.getElementById('mic-btn').classList.remove('listening');
            document.getElementById('mic-btn').innerText = "üé§ Voice";
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = document.getElementById('rate-range').value;
            utterance.pitch = document.getElementById('pitch-range').value;
            utterance.lang = document.getElementById('voice-lang-select').value;
            window.speechSynthesis.speak(utterance);
        }

        // Boot
        window.onload = init;
    </script>
</body>
</html>